# 역활
송신 호스트에서 수신 호스트로 패킷을 전달하는 것.        
라우팅 : 단순히 말하면 라우팅 테이블을 만든다.         
포워딩 : 라우팅 테이블을 보고 다음 목적지에 패킷을 전송한다.         
ex) 부산에서 서울까지 가는경우 어느 경로로 갈지를 결정하는게 **라우팅**,실제 그 길로 가는게 **포워딩**         

### IP
IP는 호스트안에 있는 네트워크 인터페이스(NIC)를 지칭하는 주소이다.                
라우터는 여러 개의 NIC를 가지고 있다. 따라서 IP주소가 여러 개다.                

### 서브넷 마스크 
어디까지 prefix이고 어디까지 host인지 컴퓨터가 식별할 수 있게 한다.                  IP주소와 항상 같이 다닌다.      
                
### 라우터의 역활
Longest Prefix Match를 수행한다.             
DHCP                    
DNS                     
NAT             
FireWall       
1. SK에서 A에게 인터넷 회선을 하나 할당한다.(IP주소를 하나 할당)
2. 할당받은 IP를 공유기에 연결하면 여러 기기들이 인터넷을 이용가능하다
3. 이때 공유기에서는 DHCP,NAT,DNS가 동작한다.
                
### 네트워크 서비스 모델
1. 보장된 전달 : 패킷이 소스 => 목적지 까지 도착하는 것을 보장한다.
2. 지연 제한 : 이내의 보장된 전달 : 패킷의 호스트간의 특정 지연 제한안에 패킷을 전달한다.
3. 최소 대역폭 보장 : 송신 호스트가 특정한 비트 속도(제한된 속도) 이하로 전송하는 한 모든 패킷이 목적지에 도달한다.

## IP 주소 체계
네트워크 계층의 프로토콜이다.호스트의 네트워크 **인터페이스를** 지칭하고, 동일 네트워크에서 각 호스트는 유일한 IP를 할당 받는다.     
라우터는 라우팅 테이블을 보고 목적지를 결정한다.         
이때 최장 프리픽스 매칭 규칙을 적용한다. 이는 가장 길게 매칭되는 prefix로 패킷을 전송하는 규칙이다.                
223.1.1.0/24  => 2^8개의 IP할당이 가능하다(호스트마다 각각 고유한 IP를 255개 사용 가능)   

IP가 224.1.2.3 이면 이는 테이블의 2번과 매칭된다.따라서 2번의 서브넷으로 포워딩된다.              
서브넷             
1. 하나의 네트워크가  분할되어 나눠진 작은 네트워크이다.        
   예를 들어 라우터에 할당된 
   ip가 223.1.2.6/24 이고 호스트가 각각 223.1.2.1 , 223.1.2.2라고 하면 
   프리픽스가 24bit라서 호스트들이 라우터의 서브넷에 속한다.그리고 2명의 호스트와 하나의 라우터는 서브넷을 구성한다.     
   2. 라우터를 거치지 않고 다른 호스트에 접근 가능한 호스트들의 집합도 서브넷의 정의이다.              
   3. prefix가 동일한 인터페이스의 집합


| IP         | NETMASK |      
|------------|---|       
| 223.1.1.0  | 24 |            
| 224.1.2.0  | 24 |           
| 223.1.3.0  | 24 |             

### IP할당 방식
1. 과거의 IP할당 방식
   1. 클래스 방식
      1. 32bit 인터넷 주소를 A~D까지의 클래스로 분리하고 클래스 내에서 IP주소를 정의한다.
      2. 
        | 클래스 | prefix | host-id |                             
        |-----|----|----|                                
        | A   | 2^7 | 2^24 |              
        | B   | 2^16 | 2^16 |                     
        | C   | 2^24 | 2^8 |
      3. 2에서 B클래스는 65,533대의 호스트를 지정 가능하다.
      4. 어떤 기관에서 B클래스 IP를 할당 받으면 65,533개의 호스트 주소가 모두 이 회사의 IP아래 존재하게 된다.
      5. 이런식으로 IP주소가 빠르게 고갈되었다.
2. CIDR 
   1. A.B.C.D/X 형식 주소에서 최상의 비트를 의미하는 X는 IP주소의 네트워크 부분을 구성한다.
   2. 즉 ,X비트까지 네트워크 주소이다.
   3. 한 기관이 주소 블록을 할당받고,이 기관 장비들의 IP주소는 공통 prefix를 공유한다.
   4. 외부 기관의 라우터는 목적지 주소가 내부 기관인 데이터 그램을 전달할 때 , 단지 앞의 x비트만을 고려한다.
        => 라우팅 테이블에서 prefix부분만 고려한다!!!!이렇게 되면 포워딩 테이블이 상당히 줄어든다.
   5. 주소의 나머지 32-x 비트들은 기관 내부에 같은 네트워크 프리픽시를 갖는 모든 장비들을 구별한다.
   6. 32-x의 비트들은 또한 기관 내부의 라우터에서 패킷을 전할때 사용된다.(호스트 식별)
   7. 또한 나머지 비트들로 추가 서브넷 구조를 가지는 게 가능하다.


### NAT (Network Address Translation)
1. IP주소가 부족해서 서브넷 안에서는 유일한 IP를 사용한다.
2. 하지만 외부로 나갈경우 내부 IP를 사용하면 충돌이 발생할 수 있다.
3. 따라서 NAT의 IP로 패킷을 전송한다.
4. 여기에는 문제점이 존재한다.
    1. 라우터가 소스 IP,포트 번호를 바꾼다.
    2. 네트워크 계층의 장비가 트랜스포트 계층 헤더를 변경한것 !
    3. 계층화가 망가진다  
    4. 만약 서버측에서 NAT기능을 사용한다면??
        1. 클라이언트는 출발지가 된다.따라서 NAT는 출발지를 기록해 놓음으로써 클라이언트를 찾는다.하지만 서버는 요청을 받는 쪽이기 때문에 항상 목적지가 된다.
        2. 클라이언트는 목적지의 사설IP에 대한 정보를 모른다.따라서 메시지를 보낼 때는 목적지의 공공IP로 정보를 보낸다.그러나 이는 공공IP이기 떄문에 이를 받은 NAT는 어떤 기기한테 온건지 알 수가 없다.(NAT 내부에서는 사설 IP를 이용함)
        3. 이를 해결하기 위해서 포트 포워딩을 사용한다
5. 포트 포워딩 
    1. NAT는 하나의 LAN안에 있는 모든 기기에 고정적인 포트 번호를 부여함
    2. 메시지를 받을 때는 이 포트 번호를 기반으로 해당 기기를 찾는다

### DHCP( Dynamic Host Configuration Protocol)
IP/mask : 192.168 1.47/24               
router : 192.168.1.1                    
DNS : 192.168.1.1                
이런 정보를 적어주는 역활을 한다.동적으로                 
1. 만약 고정 IP를 사용한다면 필요 없는 기능이다.
   1. 고정 IP는 재사용이 불가능 ,비용이 비싸다
2. 어떻게 작동할까
   1. A가 강의실에 들어갔다.
   2. A가 브로드 캐스트로 DHCP discover 를 서브넷에 보낸다.
   3. 이 패킷을 받은 호스트들은  DHCP 서버가 아니라면 다 무시한다.(서버가 아니면 port를 닫아서 다른 호스트들은 LISTEN상태가 아니다)
   4. DHCP가 offer를 보내준다.이때  offer는 브로드캐스트이다 ( 요청을 보낸 호스트의 IP가 아직 없어서)
   5. A가 offer를 수락한다는 메세지를 브로드캐스트로 보낸다.(DHCP 서버거 2개라면 다른 이미 offer 수락했다는 것을 간접적으로 알려주려고 브로드 캐스트로 보낸다)
   6. DHCP에서 ACK가 도착하면 정보가 세팅된다.                


### IP Fragmentation
1. 패킷을 전송하고자 하는데 패킷의 크기가 MTU보다 크면 한번에 전송할 수 없다.
2. 패킷을 MTU이하의 패킷으로 분할하는 것을 단편화라고 한다.

MTU가 1500Byte, 4000Byte패킷을 전송한다고 생각하자   
패킷은 총 3개로 분할되고, 만약 현재 패킷 이외의 추가 패킷이 있다면 More Flag가 1이 된다.   
그리고 offset은 8Byte 단위로 표시되고 이는 byte를 절약하기 위해서이다.        (185*8 = 1480,20Byte는 헤더를 위해서 남겨둠) 

| 순서 | 페이로드 | 헤더 | More Flag | offset |        
|---|------|----|---|------|       
| 1 | 1480 | 20 | 1 | 0 |            
| 2 | 1480 | 20 | 1 | 185 |     
| 3 | 1020 | 20 | 0 | 370 |

3. 만약 패킷이 유실된다면 ??
    1. 패킷 수신측에서 분할된 패킷의 조립이 안되서 상위 계층(트랜스포트)으로 올리지 못한다.        
    2. 따라서 패킷 전송측이 도착 응답을 받지 못했기 때문에 TimeOut이 발생
    3. 패킷 재전송


### ICMP (Internet Control message Protocol)
네트워크에서 사용자 메세지가 아니라 컨트롤 메세지를 운반하기 위한 프로토콜이다.        
EX) TTL초과로 드랍 되는경우 소스에게 REPORT가 필요하다.(IP패킷을 생성하고 여기에 발생한 정보를 담는다)           











